<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ú–∞–≥–∞–∑–∏–Ω</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f8}
header{padding:12px;background:#fff;font-weight:700}
.tabs{display:flex;gap:10px;padding:10px;overflow:auto;position:sticky;top:0;background:#f4f6f8;z-index:50}
.tab{background:#e2e8f0;padding:8px 12px;border-radius:10px;cursor:pointer;white-space:nowrap}
.tab.active{background:#cbd5e1;font-weight:700}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px;padding-bottom:420px}
.card{background:#fff;padding:10px;border-radius:12px}
.price{font-weight:bold;margin:6px 0}
.btn{width:100%;padding:10px;border:0;border-radius:10px;background:#3b82f6;color:#fff;margin-top:6px;cursor:pointer}
.btn:disabled{background:#94a3b8;cursor:not-allowed}
.pimg{width:100%;aspect-ratio:1/1;object-fit:contain;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb;margin-bottom:8px}
.cart{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:10px;border-top:1px solid #ccc}
.small{font-size:12px;color:#64748b;margin-top:6px;line-height:1.35}
.cart-list{margin-top:8px;max-height:110px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:8px;background:#f8fafc}
.cart-item{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #e5e7eb}
.ci-btn{width:34px;height:34px;border:0;border-radius:10px;cursor:pointer;background:#e2e8f0}
.ci-btn.del{background:#fee2e2}
.input{width:100%;padding:10px;margin-top:8px;border-radius:10px;border:1px solid #ccc}
.notice{margin-top:8px;padding:10px;border-radius:12px;background:#f8fafc;border:1px solid #e5e7eb}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:2000}
.modal{background:#fff;width:92%;max-width:380px;border-radius:16px;padding:16px}
</style>
</head>

<body>
<header>–ú–∞–≥–∞–∑–∏–Ω</header>

<div id="welcome" class="modal-backdrop" style="display:flex;z-index:2500;">
  <div class="modal" style="text-align:center;">
    <h3 id="welcomeText">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
    <p>–í—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ WAKA Nexa</p>
    <button class="btn" onclick="closeWelcome()">–ù–∞—á–∞—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
  </div>
</div>

<div class="tabs" id="tabs"></div>
<div class="grid" id="products"></div>

<div class="cart">
  üõí <b><span id="count">0</span></b> ¬∑ –ò—Ç–æ–≥–æ: <b><span id="total">0</span> ‚Ç∏</b>
  <div class="cart-list" id="cartList"><div class="small">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div></div>

  <input id="phone" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–ø—Ä–∏–º–µ—Ä: +7 777 123 45 67)" inputmode="tel">
  <input id="address" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏">

  <button class="btn" onclick="contactAdmin()" style="background:#10b981;">
    üì© –°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
  </button>

  <button class="btn" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>

  <div class="notice">
    <div style="font-weight:700;margin-bottom:6px;">üöö –î–æ—Å—Ç–∞–≤–∫–∞</div>
    <div class="small">
      ‚Ä¢ –ü–æ –≥–æ—Ä–æ–¥—É ‚Äî 1 000 ‚Ç∏<br>
      ‚Ä¢ (–ú–∏—á—É—Ä–∏–Ω, –ö—Ä–∞—Å–Ω—ã–π –ü–∞—Ä—Ç–∏–∑–∞–Ω, –ó–∞—Ä–µ—á–Ω—ã–π, 2 –ö–æ—Å—Ç–∞–Ω–∞–π, –¢–æ–±–æ–ª) ‚Äî 1 500 ‚Ç∏<br><br>
      ‚è± 30‚Äì60 –º–∏–Ω—É—Ç.
    </div>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
if (tg) tg.ready();

/* ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: —Ç–µ–ø–µ—Ä—å –ø–∞–ø–∫–∞ img1 */
const BASE_IMG = "https://raw.githubusercontent.com/didar2007/tg-miniapp/main/img1/";
/* ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: placeholder —Ç–æ–∂–µ –∏—â–µ–º –≤ img1 */
const DEFAULT_IMG = BASE_IMG + "placeholder.png";

function img(fileName){
  if (!fileName) return DEFAULT_IMG;
  return BASE_IMG + fileName;
}

/*
  stock ‚Äî —Å–∫—Ä—ã—Ç—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º).
  available = stock - qty_in_cart
*/
const CATEGORIES = [
  {
    id: "waka10000",
    label: "üî• WAKA 10000 ‚Äî 12.990 ‚Ç∏ üî•",
    defaultPrice: 12990,
    products: [
      { name: "üçè‚ö° Sour Apple", ru: "–ö–∏—Å–ª–æ–µ —è–±–ª–æ–∫–æ", stock: 40, img: "sour-apple10.png" },
      { name: "üîµü´ê Mr. Blue", ru: "–ß–µ—Ä–Ω–∏–∫–∞ –º–∏–∫—Å", stock: 100, img: "mr-blue10.png" },
      { name: "ü•ùü´ê Kiwi Mulberry", ru: "–ö–∏–≤–∏ ¬∑ –®–µ–ª–∫–æ–≤–∏—Ü–∞", stock: 40, img: "kiwi-mulberry10.jpg" },
      { name: "üçìüí• Lychee Burst", ru: "–õ–∏—á–∏", stock: 40, img: "lychee-burst10.jpg" },
      { name: "üç¨üòã Fruity Chews", ru: "–§—Ä—É–∫—Ç–æ–≤—ã–µ –∂–≤–∞—á–∫–∏", stock: 20, img: "fruity-chews10.jpg" }
    ]
  },
  {
    id: "waka8000",
    label: "üî• WAKA 8000 ‚Äî 10.990 ‚Ç∏ üî•",
    defaultPrice: 10990,
    products: [
      { name: "üçí Cherry", ru: "–í–∏—à–Ω—è", stock: 20, img: "cherry8.jpg" },
      { name: "üçá‚ùÑÔ∏è Iced Grape", ru: "–í–∏–Ω–æ–≥—Ä–∞–¥ —Å–æ –ª—å–¥–æ–º", stock: 20, img: "grape8.jpg" },
      { name: "ü´êüçì Blackcurrant Berry Drink", ru: "–ú–æ—Ä—Å ¬∑ –ß—ë—Ä–Ω–∞—è —Å–º–æ—Ä–æ–¥–∏–Ω–∞ ¬∑ –Ø–≥–æ–¥—ã", stock: 10, img: "mors8.jpg" },
      { name: "üçìüçâ Strawberry Watermelon", ru: "–ö–ª—É–±–Ω–∏–∫–∞ ¬∑ –ê—Ä–±—É–∑", stock: 10, img: "straberry_watermelon8.jpg" },
      { name: "üçè‚ö° Sour Apple", ru: "–ö–∏—Å–ª–æ–µ —è–±–ª–æ–∫–æ", stock: 20, img: "apple8.jpg" },
      { name: "üçì Fresh Strawberry", ru: "–°–≤–µ–∂–∞—è –∫–ª—É–±–Ω–∏–∫–∞", stock: 10, img: "straberry8.jpg" },
      { name: "üçíüçã Cherry Lemon", ru: "–í–∏—à–Ω—è ¬∑ –õ–∏–º–æ–Ω", stock: 10, img: "lemon_berry8.jpg" },
      { name: "ü•≠‚ùÑÔ∏è Iced Mango", ru: "–ú–∞–Ω–≥–æ —Å–æ –ª—å–¥–æ–º", stock: 10, img: "iced_mango8.jpg" },
      { name: "üçãüçÉ Lemon Lime", ru: "–õ–∏–º–æ–Ω ¬∑ –õ–∞–π–º", stock: 20, img: "lemon_lime8.jpg" },
      { name: "üçâ‚ùÑÔ∏è Iced Watermelon", ru: "–ê—Ä–±—É–∑ —Å–æ –ª—å–¥–æ–º", stock: 10, img: "watermelon_ice8.jpg" }
    ]
  },
  {
    id: "waka15000",
    label: "üî• WAKA 15000 ‚Äî 14.990 ‚Ç∏ üî• (–ñ–ò–î–ö–û–°–¢–¨ –í–ê–ö–ê –í –ü–û–î–ê–†–û–ö)",
    defaultPrice: 14990,
    products: [
      { name: "üçâ Watermelon", ru: "–ê—Ä–±—É–∑", stock: 3, img: "watermelon15.jpg" },
      { name: "üåµüçã Cactus Lemon", ru: "–ö–∞–∫—Ç—É—Å ¬∑ –õ–∏–º–æ–Ω", stock: 7, img: "cactus-lemon15.jpg" },
      { name: "üåø‚ùÑÔ∏è Mint", ru: "–ú—è—Ç–∞", stock: 5, img: "mint15.jpg" },
      { name: "üçè‚ö° Sour Apple", ru: "–ö–∏—Å–ª–æ–µ —è–±–ª–æ–∫–æ", stock: 9, img: "sour-apple15.jpg" }
    ]
  },
  {
    id: "waka20000",
    label: "üî• WAKA 20000 ‚Äî 14.990 ‚Ç∏ üî•",
    defaultPrice: 14990,
    products: [
      { name: "üçìü´ê Strawberry Raspberry", ru: "–ö–ª—É–±–Ω–∏–∫–∞ ¬∑ –ú–∞–ª–∏–Ω–∞", stock: 20, img: "straberry-raspberry20.jpg" },
      { name: "ü´êüçí Blueberry Cranberry Cherry", ru: "–ß–µ—Ä–Ω–∏–∫–∞ ¬∑ –ö–ª—é–∫–≤–∞ ¬∑ –í–∏—à–Ω—è", stock: 10, img: "bluberry-chanberry-cherry20.jpg" }
    ]
  },
  {
    id: "waka35000",
    label: "üî• WAKA 35000 ‚Äî 15.990 ‚Ç∏ üî• (–ñ–ò–î–ö–û–°–¢–¨ –í–ê–ö–ê –í –ü–û–î–ê–†–û–ö)",
    defaultPrice: 15990,
    products: [
      { name: "üçáü´ê Cranberry Grape", ru: "–ö–ª—é–∫–≤–∞ ¬∑ –í–∏–Ω–æ–≥—Ä–∞–¥", stock: 10, img: "chanberry-grape35.jpg" },
      { name: "üçìüçá Strawberry", ru: "–ö–ª—É–±–Ω–∏–∫–∞ ¬∑ –í–∏–Ω–æ–≥—Ä–∞–¥", stock: 10, img: "strawberry35.png" },
      { name: "üñ§ü´ê Black Raspberry", ru: "–ß—ë—Ä–Ω–∞—è –º–∞–ª–∏–Ω–∞", stock: 10, img: "black-raspberry35.jpg" }
    ]
  },
  {
    id: "liquid",
    label: "üî• WAKA –ñ–ò–î–ö–û–°–¢–¨ üî•",
    defaultPrice: 0,
    products: [
      { name: "üçâ Watermelon", ru: "–ê—Ä–±—É–∑", stock: 20, price: 0, img: "zhizha.jpg" },
      { name: "ü´êüçí Blackberry Blueberry Cherry", ru: "–ï–∂–µ–≤–∏–∫–∞ ¬∑ –ß–µ—Ä–Ω–∏–∫–∞ ¬∑ –í–∏—à–Ω—è", stock: 30, price: 0, img: "zhizha.jpg" },
      { name: "ü•§‚ùÑÔ∏è Iced Lemon Cola", ru: "–õ–∏–º–æ–Ω–Ω–∞—è –ª–µ–¥—è–Ω–∞—è –∫–æ–ª–∞", stock: 20, price: 0, img: "zhizha.jpg" },
      { name: "üå¥üçã Hawaiian Lemonade", ru: "–ì–∞–≤–∞–π—Å–∫–∏–π –ª–∏–º–æ–Ω–∞–¥", stock: 30, price: 0, img: "zhizha.jpg" },
      { name: "ü´êüçâ Blueberry Watermelon", ru: "–ß–µ—Ä–Ω–∏–∫–∞ ¬∑ –ê—Ä–±—É–∑", stock: 30, price: 0, img: "zhizha.jpg" },
      { name: "üçáüç¨ Grape Gum", ru: "–í–∏–Ω–æ–≥—Ä–∞–¥–Ω–∞—è –∂–≤–∞—á–∫–∞", stock: 30, price: 0, img: "zhizha.jpg" },
      { name: "üçìüçí Strawberry Raspberry Cherry", ru: "–ö–ª—É–±–Ω–∏–∫–∞ ¬∑ –ú–∞–ª–∏–Ω–∞ ¬∑ –í–∏—à–Ω—è", stock: 10, price: 0, img: "zhizha.jpg" },
      { name: "üçè‚ö° Sour Apple", ru: "–ö–∏—Å–ª–æ–µ —è–±–ª–æ–∫–æ", stock: 10, price: 0, img: "zhizha.jpg" },
      { name: "üçãü´ê Sour Berry Lemonade", ru: "–õ–∏–º–æ–Ω–∞–¥ ¬∑ –ö–∏—Å–ª–∞—è —è–≥–æ–¥–∞", stock: 30, price: 0, img: "zhizha.jpg" },
      { name: "ü•§ Sprite", ru: "–°–ø—Ä–∞–π—Ç", stock: 10, price: 0, img: "zhizha.jpg" },
      { name: "üåäüçã Sea Salt Lemon", ru: "–ú–æ—Ä—Å–∫–∞—è —Å–æ–ª—å ¬∑ –õ–∏–º–æ–Ω", stock: 20, price: 0, img: "zhizha.jpg" }
    ]
  }
];

function closeWelcome(){
  const w = document.getElementById("welcome");
  if (w) w.style.display = "none";
  if (tg && typeof tg.expand === "function") tg.expand();
}
document.getElementById("welcome").addEventListener("click", (e) => {
  if (e.target && e.target.id === "welcome") closeWelcome();
});

function contactAdmin(){
  const username = "salemhanovvv";
  if (window.Telegram && Telegram.WebApp) {
    Telegram.WebApp.openTelegramLink("https://t.me/" + username);
  } else {
    window.open("https://t.me/" + username, "_blank");
  }
}

let cart = {};

function cartQtyFor(key){ return cart[key]?.qty || 0; }
function getCategory(catId){ return CATEGORIES.find(c => c.id === catId); }
function getProduct(catId, index){
  const cat = getCategory(catId);
  return cat ? (cat.products[index] || null) : null;
}
function productKey(catId, index){ return `${catId}-${index}`; }

function getUnitPrice(cat, prod){
  if (typeof prod.price === "number") return prod.price;
  return cat.defaultPrice;
}

function availableStock(catId, index){
  const prod = getProduct(catId, index);
  if (!prod) return 0;
  const key = productKey(catId, index);
  return Math.max(0, (prod.stock || 0) - cartQtyFor(key));
}

function updateCartUI(){
  const items = Object.values(cart);
  const count = items.reduce((s,i)=>s+i.qty,0);
  const total = items.reduce((s,i)=>s+i.qty*i.price,0);

  document.getElementById("count").innerText = count;
  document.getElementById("total").innerText = total;

  const list = document.getElementById("cartList");
  if(!items.length){
    list.innerHTML = "<div class='small'>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>";
  } else {
    list.innerHTML = items.map(i => `
      <div class="cart-item">
        <div>
          <b>${i.name}</b><br>
          <span class="small">${i.ru}</span><br>
          <span class="small">‚Ç∏${i.price} √ó ${i.qty}</span>
        </div>
        <div style="display:flex;gap:6px;">
          <button class="ci-btn" onclick="incQty('${i.key}')">+</button>
          <button class="ci-btn" onclick="decQty('${i.key}')">‚àí</button>
          <button class="ci-btn del" onclick="removeItem('${i.key}')">‚úï</button>
        </div>
      </div>
    `).join("");
  }

  refreshProductButtons();
}

function addToCart(catId, index){
  const cat = getCategory(catId);
  const prod = getProduct(catId, index);
  if (!cat || !prod) return;

  const key = productKey(catId, index);
  const avail = availableStock(catId, index);

  if (avail <= 0){
    alert("–¢–æ–≤–∞—Ä –∑–∞–∫–æ–Ω—á–∏–ª—Å—è");
    refreshProductButtons();
    return;
  }

  const price = getUnitPrice(cat, prod);

  if (cart[key]) cart[key].qty++;
  else cart[key] = {
    key, catId, index,
    name: prod.name, ru: prod.ru,
    price, qty: 1
  };

  updateCartUI();
}

function incQty(key){
  const item = cart[key];
  if (!item) return;

  const avail = availableStock(item.catId, item.index);
  if (avail <= 0){
    alert("–¢–æ–≤–∞—Ä –∑–∞–∫–æ–Ω—á–∏–ª—Å—è");
    refreshProductButtons();
    return;
  }
  item.qty++;
  updateCartUI();
}

function decQty(key){
  const item = cart[key];
  if (!item) return;
  item.qty--;
  if (item.qty <= 0) delete cart[key];
  updateCartUI();
}

function removeItem(key){
  delete cart[key];
  updateCartUI();
}

function buildTabs(){
  const tabs = document.getElementById("tabs");
  tabs.innerHTML = "";
  CATEGORIES.forEach((c) => {
    const el = document.createElement("div");
    el.className = "tab";
    el.dataset.cat = c.id;
    el.textContent = (c.id === "liquid") ? "–ñ–ò–î–ö–û–°–¢–¨" : c.id.replace("waka","WAKA ").toUpperCase();
    el.onclick = () => loadCategory(c.id);
    tabs.appendChild(el);
  });
}

let currentCatId = CATEGORIES[0].id;

function loadCategory(catId){
  currentCatId = catId;

  document.querySelectorAll(".tab").forEach(t => {
    t.classList.toggle("active", t.dataset.cat === catId);
  });

  const cat = getCategory(catId);
  const box = document.getElementById("products");
  box.innerHTML = "";

  if (!cat){
    box.innerHTML = "<div class='small'>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>";
    return;
  }

  cat.products.forEach((p, i) => {
    const key = productKey(catId, i);
    const price = getUnitPrice(cat, p);
    const priceText = (price && price > 0) ? `‚Ç∏${price}` : "–¶–µ–Ω–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è";

    box.innerHTML += `
      <div class="card" data-key="${key}">
        <img class="pimg" src="${img(p.img)}" onerror="this.src='${DEFAULT_IMG}'">
        <div><b>${p.name}</b></div>
        <div class="small">${p.ru}</div>
        <div class="price">${priceText}</div>
        <button class="btn add-btn" onclick="addToCart('${catId}', ${i})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
    `;
  });

  refreshProductButtons();
}

function refreshProductButtons(){
  const catId = currentCatId;
  const cat = getCategory(catId);
  if (!cat) return;

  cat.products.forEach((p, i) => {
    const key = productKey(catId, i);
    const card = document.querySelector(`.card[data-key="${key}"]`);
    if (!card) return;

    const btn = card.querySelector(".add-btn");
    if (!btn) return;

    const avail = availableStock(catId, i);

    if ((p.stock || 0) <= 0 || avail <= 0){
      btn.disabled = true;
      btn.textContent = "–ó–∞–∫–æ–Ω—á–∏–ª—Å—è";
    } else {
      btn.disabled = false;
      btn.textContent = "–í –∫–æ—Ä–∑–∏–Ω—É";
    }
  });
}

function normalizePhone(raw){
  return (raw || "").replace(/[^\d+]/g, "");
}
function isValidPhone(p){
  const digits = p.replace(/\D/g, "");
  return digits.length >= 10 && digits.length <= 15;
}

function checkout(){
  if(!tg) return alert("–û—Ç–∫—Ä–æ–π –≤ Telegram");

  const items = Object.values(cart);
  if(!items.length) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");

  const phoneRaw = document.getElementById("phone").value.trim();
  const phone = normalizePhone(phoneRaw);
  if(!isValidPhone(phone)) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞");

  const addr = document.getElementById("address").value.trim();
  if(addr.length < 5) return alert("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å");

  const total = items.reduce((s,i)=>s+i.qty*i.price,0);

  tg.sendData(JSON.stringify({
    phone,
    address: addr,
    items: items.map(i => ({
      catId: i.catId,
      index: i.index,
      name: i.name,
      ru: i.ru,
      price: i.price,
      qty: i.qty
    })),
    total
  }));

  tg.close();
}

// init
buildTabs();
loadCategory(CATEGORIES[0].id);
updateCartUI();
</script>
</body>
</html>
