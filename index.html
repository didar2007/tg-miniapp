<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ú–∞–≥–∞–∑–∏–Ω</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  body{font-family:Arial;margin:0;background:#f4f6f8}
  header{padding:12px;background:#fff;font-weight:700}

  .tabs{display:flex;gap:10px;padding:10px;overflow:auto}
  .tab{background:#e2e8f0;padding:8px 12px;border-radius:10px;cursor:pointer;white-space:nowrap}
  .tab.active{background:#cbd5e1;font-weight:700}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px;padding-bottom:260px}
  .card{background:#fff;padding:10px;border-radius:12px}
  .price{font-weight:bold;margin:6px 0}
  .btn{width:100%;padding:10px;border:0;border-radius:10px;background:#3b82f6;color:#fff;margin-top:6px;cursor:pointer}
  .btn.gray{background:#64748b}
  .btn.red{background:#ef4444}

  .pimg{
    width:100%;
    aspect-ratio: 1 / 1;
    object-fit: contain;
    background:#f8fafc;
    border-radius:12px;
    border:1px solid #e5e7eb;
    margin-bottom:8px;
  }

  .cart{
    position:fixed;bottom:0;left:0;right:0;
    background:#fff;padding:10px;border-top:1px solid #ccc;
  }
  .small{font-size:12px;color:#64748b;margin-top:6px}
  .cart-top{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
  .cart-list{
    margin-top:8px;max-height:110px;overflow:auto;
    border:1px solid #e5e7eb;border-radius:12px;padding:8px;background:#f8fafc;
  }
  .cart-item{
    display:flex;justify-content:space-between;gap:8px;
    padding:6px 0;border-bottom:1px dashed #e5e7eb;
  }
  .cart-item:last-child{border-bottom:0}
  .ci-title{font-size:12px;line-height:1.25;color:#0f172a;flex:1}
  .ci-right{display:flex;gap:6px;align-items:center}
  .ci-qty{
    min-width:34px;text-align:center;font-size:12px;
    padding:6px 8px;border-radius:10px;background:#e2e8f0;
  }
  .ci-btn{
    width:34px;height:34px;border:0;border-radius:10px;cursor:pointer;
    background:#e2e8f0;
  }
  .ci-btn.del{background:#fee2e2}
  .input{
    width:100%;padding:10px;margin-top:8px;border-radius:10px;border:1px solid #ccc;
    box-sizing:border-box;
  }

  .modal-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,0.6);
    display:none;align-items:center;justify-content:center;z-index:2000;
  }
  .modal{
    background:#fff;width:92%;max-width:380px;border-radius:16px;padding:16px;
  }
  .modal h3{margin:0 0 8px}
  .modal p{margin:6px 0}
  .modal-actions{display:flex;gap:10px;margin-top:12px}
</style>
</head>

<body>
<header>–ú–∞–≥–∞–∑–∏–Ω</header>

<!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
<div id="welcome" class="modal-backdrop" style="display:flex;z-index:2500;">
  <div class="modal" style="text-align:center;">
    <h3 id="welcomeText">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
    <p>–í—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ WAKA Nexa</p>
    <button class="btn" onclick="closeWelcome()">–ù–∞—á–∞—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
    <div class="small">–ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ —Ç–æ–≤–∞—Ä —Å–ª—É—á–∞–π–Ω–æ ‚Äî –≤ –∫–æ—Ä–∑–∏–Ω–µ –µ—Å—Ç—å ‚Äú‚àí‚Äù –∏ ‚Äú‚úï‚Äù.</div>
  </div>
</div>

<!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ -->
<div id="confirm" class="modal-backdrop">
  <div class="modal">
    <h3>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑</h3>
    <div id="confirmBody" style="font-size:14px;line-height:1.35;"></div>
    <div class="modal-actions">
      <button class="btn gray" onclick="closeConfirm()">–ù–∞–∑–∞–¥</button>
      <button class="btn" onclick="sendOrder()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="tabs" id="tabs">
  <div class="tab" data-cat="waka6000" onclick="load('waka6000')">WAKA 6000</div>
  <div class="tab" data-cat="waka8000" onclick="load('waka8000')">WAKA 8000</div>
  <div class="tab" data-cat="waka10000" onclick="load('waka10000')">WAKA 10000</div>
</div>

<div class="grid" id="products"></div>

<div class="cart">
  <div class="cart-top">
    <div>üõí –í –∫–æ—Ä–∑–∏–Ω–µ: <b><span id="count">0</span></b> ¬∑ –ò—Ç–æ–≥–æ: <b><span id="total">0</span> ‚Ç∏</b></div>
    <button class="btn red" style="width:auto;padding:10px 12px;margin-top:0;" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>

  <div class="cart-list" id="cartList">
    <div class="small">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
  </div>

  <input id="address" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –∫–≤.)">

  <button class="btn" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
  <div class="small">–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –∞–¥–º–∏–Ω—É –≤ Telegram.</div>
</div>

<script>
const tg = window.Telegram?.WebApp;
if (tg) tg.ready();

/* ===== –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å 1 —Ä–∞–∑) ===== */
(function initWelcome(){
  const welcomeEl = document.getElementById("welcome");
  const welcomeTextEl = document.getElementById("welcomeText");

  const user = tg?.initDataUnsafe?.user;
  if(user && welcomeTextEl){
    welcomeTextEl.innerText = "–ü—Ä–∏–≤–µ—Ç, " + user.first_name + " üëã";
  }

  if(localStorage.getItem("welcomed") === "yes"){
    welcomeEl.style.display = "none";
  }
})();

function closeWelcome(){
  localStorage.setItem("welcomed", "yes");
  document.getElementById("welcome").style.display = "none";
}

/* ===== –î–∞–Ω–Ω—ã–µ –≤–∫—É—Å–æ–≤ ===== */
const data = {
  waka6000: [
    "–ö–ª—É–±–Ω–∏–∫–∞ –≤–∏–Ω–æ–≥—Ä–∞–¥",
    "–ì–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–∏—à–Ω—è –ª–∞–π–º",
    "–ú—è—Ç–Ω–∞—è —á–µ—Ä–Ω–∏–∫–∞",
    "–Ø–≥–æ–¥–Ω—ã–π –º–∏–∫—Å",
    "–ö–∏—Å–ª–∞—è –∫–ª—É–±–Ω–∏–∫–∞",
    "–í–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π –º–æ—Ä—Å",
    "–ß—É–ø—Å –∫–ª—É–±–Ω–∏–∫–∞ –º–∞–ª–∏–Ω–∞",
    "–ê—Ä–±—É–∑–Ω–∞—è –∂–≤–∞—á–∫–∞"
  ],
  waka8000: [
    "–ê—Ä–±—É–∑",
    "–ú—è—Ç–∞",
    "–í–∏—à–Ω—è",
    "–ß–µ—Ä–Ω–∏–∫–∞ –∫–ª—é–∫–≤–∞ –≤–∏—à–Ω—è",
    "–°–∞–∫—É—Ä–∞ –≤–∏–Ω–æ–≥—Ä–∞–¥",
    "–ö–ª—É–±–Ω–∏–∫–∞ –º–∞–ª–∏–Ω–∞",
    "–õ–∏–º–æ–Ω–Ω–∞—è –∫–æ–ª–∞",
    "–ú–æ—Ä—Å–∫–∞—è —Å–æ–ª—å –ª–∏–º–æ–Ω"
  ],
  waka10000: [
    "–ö–ª—É–±–Ω–∏–∫–∞ –±–∞–Ω–∞–Ω",
    "–°–≤–µ–∂–∞—è –º—è—Ç–∞",
    "–°–∞–∫—É—Ä–∞ –≤–∏–Ω–æ–≥—Ä–∞–¥",
    "–ß–µ—Ä–Ω–∞—è –≤–∏—à–Ω—è",
    "–ß–µ—Ä–Ω–∏–∫–∞ –∫–ª—é–∫–≤–∞ –≤–∏—à–Ω—è",
    "–ñ–µ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑–∏–Ω–∫–∏",
    "–ì–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —è–≥–æ–¥–∞ –∫–∏—Å–ª–∞—è",
    "–ú–∏—Å—Ç–µ—Ä –±–ª—é",
    "–Ø–±–ª–æ—á–Ω—ã–π –≤–∑—Ä—ã–≤",
    "–ê—Ä–±—É–∑",
    "–í–∏–Ω–æ–≥—Ä–∞–¥ —è–±–ª–æ–∫–æ",
    "–í–∏—à–Ω—ë–≤–æ —è–≥–æ–¥–Ω—ã–π –ª—ë–¥"
  ]
};

function getPrice(cat){
  if(cat === "waka6000") return 9990;
  if(cat === "waka8000") return 10990;
  if(cat === "waka10000") return 12990;
  return 0;
}

/* ===== –ö–ê–†–¢–ò–ù–ö–ò ===== */
const DEFAULT_IMG = "img/placeholder.png"; // –¥–æ–±–∞–≤—å placeholder.png –≤ img/ –∏–ª–∏ –ø–æ–º–µ–Ω—è–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é

// –ö–ª—é—á = –¢–û–ß–ù–û–ï –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∫—É—Å–∞ –∏–∑ –º–∞—Å—Å–∏–≤–∞ data (—Ä–µ–≥–∏—Å—Ç—Ä –∏ –ø—Ä–æ–±–µ–ª—ã –≤–∞–∂–Ω—ã)
const images = {
  // WAKA 6000 (—Ç–≤–æ–∏ –∑–∞–º–µ–Ω—ã)
  "–ö–ª—É–±–Ω–∏–∫–∞ –≤–∏–Ω–æ–≥—Ä–∞–¥": "img/str-grape6.PNG",
  "–ì–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–∏—à–Ω—è –ª–∞–π–º": "img/vish-lime6.PNG",
  "–ú—è—Ç–Ω–∞—è —á–µ—Ä–Ω–∏–∫–∞": "img/blue-malina-vish10.PNG",
  "–Ø–≥–æ–¥–Ω—ã–π –º–∏–∫—Å": "img/chern-klu-vish10.PNG",
  "–ö–∏—Å–ª–∞—è –∫–ª—É–±–Ω–∏–∫–∞": "img/str-soda10.PNG",
  "–í–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π –º–æ—Ä—Å": "img/green-grape6.PNG",
  "–ß—É–ø—Å –∫–ª—É–±–Ω–∏–∫–∞ –º–∞–ª–∏–Ω–∞": "img/str-mal6.PNG",
  "–ê—Ä–±—É–∑–Ω–∞—è –∂–≤–∞—á–∫–∞": "img/watermelon6.PNG",

  // WAKA 8000 (—Ç–≤–æ—è –∑–∞–º–µ–Ω–∞)
  "–õ–∏–º–æ–Ω–Ω–∞—è –∫–æ–ª–∞": "img/str-soda10.PNG",

  // WAKA 10000 (—Ç–≤–æ–∏ –∑–∞–º–µ–Ω—ã)
  "–°–≤–µ–∂–∞—è –º—è—Ç–∞": "img/myata10.PNG",
  "–ß–µ—Ä–Ω–∞—è –≤–∏—à–Ω—è": "img/vishnya10.PNG",
  "–ñ–µ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑–∏–Ω–∫–∏": "img/fruits10.PNG",
  "–ú–∏—Å—Ç–µ—Ä –±–ª—é": "img/fruits10.PNG",
  "–í–∏—à–Ω—ë–≤–æ —è–≥–æ–¥–Ω—ã–π –ª—ë–¥": "img/chern-klu-vish10.PNG"
};

function getImageByFlavor(flavor){
  return images[flavor] || DEFAULT_IMG;
}

/* cart[key] = { key, title, model, flavor, price, qty } */
let cart = {};
let pendingOrder = null;

/* ===== UI helpers ===== */
function setActiveTab(cat){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.cat === cat);
  });
}

function updateCartUI(){
  const items = Object.values(cart);
  const totalQty = items.reduce((s, it) => s + it.qty, 0);
  const totalSum = items.reduce((s, it) => s + it.qty * it.price, 0);

  document.getElementById("count").innerText = totalQty;
  document.getElementById("total").innerText = totalSum;

  const list = document.getElementById("cartList");
  if(items.length === 0){
    list.innerHTML = `<div class="small">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>`;
    return;
  }

  list.innerHTML = items.map(it => `
    <div class="cart-item">
      <div class="ci-title">
        <b>${escapeHtml(it.title)}</b> ‚Äî ${escapeHtml(it.flavor)}<br>
        <span class="small">‚Ç∏${it.price} √ó ${it.qty} = ‚Ç∏${it.price * it.qty}</span>
      </div>
      <div class="ci-right">
        <button class="ci-btn" onclick="decQty('${it.key}')">‚àí</button>
        <div class="ci-qty">${it.qty}</div>
        <button class="ci-btn" onclick="incQty('${it.key}')">+</button>
        <button class="ci-btn del" onclick="removeItem('${it.key}')">‚úï</button>
      </div>
    </div>
  `).join("");
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===== –ö–æ—Ä–∑–∏–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è ===== */
function addToCart(item){
  const key = item.key;
  if(cart[key]) cart[key].qty += 1;
  else cart[key] = { ...item, qty: 1 };
  updateCartUI();
}
function incQty(key){ if(cart[key]) cart[key].qty += 1; updateCartUI(); }
function decQty(key){
  if(!cart[key]) return;
  cart[key].qty -= 1;
  if(cart[key].qty <= 0) delete cart[key];
  updateCartUI();
}
function removeItem(key){ if(cart[key]) delete cart[key]; updateCartUI(); }
function clearCart(){ cart = {}; updateCartUI(); }

/* ===== –†–µ–Ω–¥–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤ ===== */
function load(cat){
  setActiveTab(cat);

  const box = document.getElementById("products");
  box.innerHTML = "";

  const price = getPrice(cat);
  const model = cat.replace("waka","");
  const title = `WAKA ${model}`;

  data[cat].forEach((flavor, index) => {
    const key = `${cat}-${index}`;
    const img = getImageByFlavor(flavor);

    box.innerHTML += `
      <div class="card">
        <img class="pimg" src="${img}" alt="${escapeHtml(flavor)}" onerror="this.src='${DEFAULT_IMG}'">
        <div><b>${escapeHtml(title)}</b> ‚Äî ${escapeHtml(flavor)}</div>
        <div class="price">‚Ç∏${price}</div>
        <button class="btn"
          data-key="${key}"
          data-title="${escapeHtml(title)}"
          data-model="${model}"
          data-flavor="${escapeHtml(flavor)}"
          data-price="${price}"
          onclick="handleAdd(this)">
          –í –∫–æ—Ä–∑–∏–Ω—É
        </button>
      </div>
    `;
  });
}

function handleAdd(btn){
  addToCart({
    key: btn.dataset.key,
    title: btn.dataset.title,
    model: btn.dataset.model,
    flavor: btn.dataset.flavor,
    price: Number(btn.dataset.price)
  });
}

/* ===== –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ===== */
function closeConfirm(){ document.getElementById("confirm").style.display = "none"; }

function checkout(){
  if(!tg){ alert("–û—Ç–∫—Ä–æ–π –º–∞–≥–∞–∑–∏–Ω –≤–Ω—É—Ç—Ä–∏ Telegram"); return; }

  const items = Object.values(cart);
  if(items.length === 0){ alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞"); return; }

  const address = document.getElementById("address").value.trim();
  if(address.length < 5){ alert("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"); return; }

  const total = items.reduce((s, it) => s + it.qty * it.price, 0);

  pendingOrder = {
    type: "order",
    address,
    items: items.map(it => ({
      title: it.title,
      model: it.model,
      flavor: it.flavor,
      price: it.price,
      qty: it.qty
    })),
    total
  };

  const lines = pendingOrder.items.map(it =>
    `‚Ä¢ <b>${escapeHtml(it.title)}</b> ‚Äî ${escapeHtml(it.flavor)} √ó${it.qty} = ‚Ç∏${it.price * it.qty}`
  ).join("<br>");

  document.getElementById("confirmBody").innerHTML =
    `<b>–ê–¥—Ä–µ—Å:</b> ${escapeHtml(pendingOrder.address)}<br><br>` +
    `<b>–¢–æ–≤–∞—Ä—ã:</b><br>${lines}<br><br>` +
    `<b>–ò—Ç–æ–≥–æ:</b> ‚Ç∏${pendingOrder.total}`;

  document.getElementById("confirm").style.display = "flex";
}

function sendOrder(){
  if(!pendingOrder) return;
  tg.sendData(JSON.stringify(pendingOrder));
  tg.close();
}

/* ===== –°—Ç–∞—Ä—Ç ===== */
load("waka6000");
updateCartUI();
</script>
</body>
</html>
